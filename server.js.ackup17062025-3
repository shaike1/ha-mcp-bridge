const express = require('express');
const app = express();
const PORT = process.env.PORT || 3001;
const HA_URL = process.env.HOME_ASSISTANT_URL;
const HA_TOKEN = process.env.HOME_ASSISTANT_TOKEN;
const MCP_API_KEY = process.env.MCP_API_KEY || 'default-key';
const SERVER_URL = process.env.SERVER_URL || 'https://ha-mcp.right-api.com';

console.log('ğŸš€ Starting Home Assistant MCP Server');
console.log('ğŸŒ SERVER_URL:', SERVER_URL);
console.log('ğŸ“¡ HA_URL:', HA_URL);
console.log('ğŸ”‘ HA_TOKEN:', HA_TOKEN ? 'configured' : 'missing');

app.use(express.json());

// CORS for all requests - enhanced for mcp-remote
app.use((req, res, next) => {
    res.setHeader('Access-Control-Allow-Origin', '*');
    res.setHeader('Access-Control-Allow-Methods', 'GET, POST, OPTIONS, HEAD');
    res.setHeader('Access-Control-Allow-Headers', 'Content-Type, Authorization, X-Requested-With');
    res.setHeader('Access-Control-Max-Age', '86400');
    
    if (req.method === 'OPTIONS') {
        console.log('âœ… OPTIONS request handled');
        res.status(200).end();
        return;
    }
    next();
});

// Enhanced authentication middleware
function authenticate(req, res, next) {
    const authHeader = req.headers.authorization;
    const envAuth = req.headers['authorization'] || process.env.AUTHORIZATION;
    const token = authHeader?.replace('Bearer ', '');

    // Log authentication attempt
    console.log('ğŸ” Auth attempt:', {
        hasAuthHeader: !!authHeader,
        hasEnvAuth: !!envAuth,
        tokenLength: token?.length || 0,
        mcpKeyConfigured: MCP_API_KEY !== 'default-key',
        headers: Object.keys(req.headers)
    });

    // Allow various authentication methods (temporarily permissive for testing)
    if (!MCP_API_KEY || MCP_API_KEY === 'default-key' || 
        token === MCP_API_KEY || 
        envAuth === `Bearer ${MCP_API_KEY}` ||
        token ||
        req.headers['user-agent']?.includes('Claude')) {
        console.log('âœ… Authentication successful');
        return next();
    }

    console.log('âŒ Authentication failed');
    return res.status(401).json({ error: 'unauthorized' });
}

// Home Assistant API functions
async function callHomeAssistant(endpoint, method = 'GET', data = null) {
    if (!HA_URL || !HA_TOKEN) {
        throw new Error('Home Assistant not configured');
    }

    const url = `${HA_URL}${endpoint}`;
    const options = {
        method,
        headers: {
            'Authorization': `Bearer ${HA_TOKEN}`,
            'Content-Type': 'application/json',
        }
    };

    if (data && method !== 'GET') {
        options.body = JSON.stringify(data);
    }

    const response = await fetch(url, options);
    if (!response.ok) {
        throw new Error(`HA API error: ${response.status} ${response.statusText}`);
    }

    return await response.json();
}

// Tool execution functions
async function getEntities(domain = null) {
    console.log('ğŸ  Getting entities, domain:', domain);
    const entities = await callHomeAssistant('/api/states');

    if (domain) {
        return entities.filter(entity => entity.entity_id.startsWith(domain + '.'));
    }

    return entities;
}

async function callService(domain, service, entity_id, data = {}) {
    console.log('ğŸ”§ Calling service:', domain, service, entity_id);
    const serviceData = { ...data };
    if (entity_id) {
        serviceData.entity_id = entity_id;
    }

    return await callHomeAssistant(`/api/services/${domain}/${service}`, 'POST', serviceData);
}

async function getAutomations() {
    console.log('ğŸ¤– Getting automations');
    return await getEntities('automation');
}

// MCP Protocol - Root endpoint for JSON-RPC
app.post('/', authenticate, async (req, res) => {
    console.log('ğŸ”§ MCP JSON-RPC request:', req.body?.method);

    const { method, params, id } = req.body;

    try {
        let result;

        switch (method) {
            case 'initialize':
                result = {
                    protocolVersion: "2024-11-05",
                    capabilities: {
                        tools: {},
                        resources: {},
                        prompts: {}
                    },
                    serverInfo: {
                        name: "Home Assistant MCP",
                        version: "1.0.0"
                    }
                };
                console.log('âœ… MCP client initialized');
                break;

            case 'tools/list':
                result = {
                    tools: [
                        {
                            name: 'get_entities',
                            description: 'Get all Home Assistant entities or filter by domain',
                            inputSchema: {
                                type: 'object',
                                properties: {
                                    domain: {
                                        type: 'string',
                                        description: 'Filter by domain (light, switch, sensor, etc.)'
                                    }
                                }
                            }
                        },
                        {
                            name: 'call_service',
                            description: 'Call a Home Assistant service to control devices',
                            inputSchema: {
                                type: 'object',
                                properties: {
                                    domain: { type: 'string', description: 'Service domain (light, switch, etc.)' },
                                    service: { type: 'string', description: 'Service name (turn_on, turn_off, etc.)' },
                                    entity_id: { type: 'string', description: 'Target entity ID' },
                                    data: { type: 'object', description: 'Additional service data' }
                                },
                                required: ['domain', 'service']
                            }
                        },
                        {
                            name: 'get_automations',
                            description: 'Get all Home Assistant automations',
                            inputSchema: {
                                type: 'object',
                                properties: {}
                            }
                        },
                        {
                            name: 'get_lights',
                            description: 'Get all light entities',
                            inputSchema: {
                                type: 'object',
                                properties: {}
                            }
                        },
                        {
                            name: 'get_switches',
                            description: 'Get all switch entities',
                            inputSchema: {
                                type: 'object',
                                properties: {}
                            }
                        }
                    ]
                };
                break;

            // Add missing methods that Claude is trying to call
            case 'prompts/list':
                result = {
                    prompts: []
                };
                console.log('âœ… Prompts list requested (empty)');
                break;

            case 'resources/list':
                result = {
                    resources: []
                };
                console.log('âœ… Resources list requested (empty)');
                break;

            case 'tools/call':
                const { name, arguments: args } = params;
                console.log('ğŸ”§ Tool called:', name, args);

                let toolResult;

                try {
                    switch (name) {
                        case 'get_entities':
                            toolResult = await getEntities(args?.domain);
                            break;
                        case 'call_service':
                            toolResult = await callService(args.domain, args.service, args.entity_id, args.data);
                            break;
                        case 'get_automations':
                            toolResult = await getAutomations();
                            break;
                        case 'get_lights':
                            toolResult = await getEntities('light');
                            break;
                        case 'get_switches':
                            toolResult = await getEntities('switch');
                            break;
                        default:
                            throw new Error(`Unknown tool: ${name}`);
                    }

                    result = {
                        content: [
                            {
                                type: 'text',
                                text: JSON.stringify(toolResult, null, 2)
                            }
                        ]
                    };

                } catch (error) {
                    console.error('âŒ Tool execution error:', error);
                    result = {
                        content: [
                            {
                                type: 'text',
                                text: `Error: ${error.message}`
                            }
                        ]
                    };
                }
                break;

            case 'notifications/initialized':
                console.log('âœ… Client initialized notification');
                return res.status(200).json({});

            default:
                console.log('âŒ Unknown method:', method);
                throw new Error(`Unknown method: ${method}`);
        }

        res.json({ jsonrpc: "2.0", id, result });

    } catch (error) {
        console.error('âŒ MCP error:', error);
        res.json({
            jsonrpc: "2.0",
            id,
            error: { code: -32603, message: error.message }
        });
    }
});

// Health check and HEAD support
app.get('/health', (req, res) => {
    res.json({
        status: 'ok',
        server_url: SERVER_URL,
        ha_configured: !!(HA_URL && HA_TOKEN),
        tools: ['get_entities', 'call_service', 'get_automations', 'get_lights', 'get_switches'],
        mcp_methods: ['initialize', 'tools/list', 'tools/call', 'prompts/list', 'resources/list', 'notifications/initialized']
    });
});

app.head('/', (req, res) => {
    res.status(200).end();
});

app.head('/health', (req, res) => {
    res.status(200).end();
});

// OAuth endpoints (for Claude Web)
app.get('/.well-known/oauth-protected-resource', (req, res) => {
    res.json({
        resource: SERVER_URL,
        authorization_servers: [SERVER_URL],
        scopes_supported: ["homeassistant:read", "homeassistant:write"]
    });
});

app.get('/.well-known/oauth-authorization-server', (req, res) => {
    res.json({
        issuer: SERVER_URL,
        authorization_endpoint: `${SERVER_URL}/oauth/authorize`,
        token_endpoint: `${SERVER_URL}/oauth/token`,
        scopes_supported: ["homeassistant:read", "homeassistant:write"],
        response_types_supported: ["code"],
        grant_types_supported: ["authorization_code"],
        code_challenge_methods_supported: ["S256"],
        token_endpoint_auth_methods_supported: ["client_secret_basic", "client_secret_post"]
    });
});

app.get('/.well-known/mcp', (req, res) => {
    res.json({
        version: "2024-11-05",
        name: "Home Assistant MCP",
        description: "Control and manage Home Assistant devices",
        methods: ['initialize', 'tools/list', 'tools/call', 'prompts/list', 'resources/list', 'notifications/initialized']
    });
});

// OAuth endpoints that mcp-remote expects
app.get('/oauth/authorize', (req, res) => {
    // For simplicity, just redirect back with a dummy code
    const redirectUri = req.query.redirect_uri || `${SERVER_URL}/oauth/callback`;
    const state = req.query.state || '';
    res.redirect(`${redirectUri}?code=dummy_auth_code&state=${state}`);
});

app.post('/oauth/token', (req, res) => {
    // Return a dummy token that matches our MCP_API_KEY
    res.json({
        access_token: MCP_API_KEY,
        token_type: "Bearer",
        expires_in: 3600,
        scope: "homeassistant:read homeassistant:write"
    });
});

// Error handling middleware
app.use((err, req, res, next) => {
    console.error('ğŸ’¥ Unhandled error:', err);
    res.status(500).json({ error: 'Internal server error' });
});

app.listen(PORT, '0.0.0.0', () => {
    console.log(`âœ… Home Assistant MCP Server running on port ${PORT}`);
    console.log(`ğŸŒ Server URL: ${SERVER_URL}`);
    console.log(`ğŸ  Home Assistant: ${HA_URL || 'Not configured'}`);
    console.log(`ğŸ”§ Available tools: get_entities, call_service, get_automations, get_lights, get_switches`);
    console.log(`ğŸ“‹ Supported MCP methods: initialize, tools/list, tools/call, prompts/list, resources/list, notifications/initialized`);
});
